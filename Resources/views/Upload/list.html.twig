{% trans_default_domain 'upload_data' %}
{% set is_ajax = app.request.isXmlHttpRequest() %}
{% extends is_ajax ? config.getTemplate('ajax') : config.getTemplate('layout') %}

{% block headline %}{{ 'title.list'|trans }}{% endblock %}

{% from '@UploadData/macros.html.twig' import bs_icon, bs_upload_status as status %}

{% set type = app.request.get('type') %}
{% set listMapper = config.getListMapper() %}

{% block content_row %}
    <div class="panel panel-default">
        <div class="panel-body">
            <a class="btn btn-primary" data-ajax data-after="showModal"
               href="{{ path('upload_data_upload_new', {type: type}) }}">{{ 'link.new_upload'|trans }}</a>
        </div>
    </div>
    {{ parent() }}

    <div class="progress fade" id="upload-progress">
        <div class="progress-bar" style="width: 0%;"></div>
    </div>

{% endblock %}

{% block content %}
    {% if is_ajax %}{{ include('@UploadData/flash.html.twig') }}{% endif %}

    <div {% if not is_ajax %}id="upload-list-container"{% endif %}>

        {% block before_table %}{% endblock %}

        {{ include(config.getTemplate('upload_table'), {config: config}) }}

        {% block pagination %}
            {{ knp_pagination_render(items) }}
        {% endblock %}

        {% block after_table %}{% endblock %}

    </div>
{% endblock %}

{% block foot_script %}
    {{ parent() }}
    <script src="{{ asset('bundles/uploaddata/js/upload.js') }}"></script>
    <script>

        var upload = new UploadData({
            container: $('#upload-list-container'),
            url_refresh: '{{ app.request.getRequestUri() }}',
            auto_reload: 30000
        });

        function showModal(html) {
            $("#new_upload").remove();
            $('body').append(html);
            $("#new_upload").modal();

            var noty = null;

            $('form :file', '#new_upload').fileupload({
                url: '{{ path('upload_data_upload_new', {type: type}) }}',
                dataType: 'json',
                start: function () {
                    $('#upload-progress').show();
                    {% block ajax_upload_start %}
                    if (window['PNotify'] != undefined) {
                        noty = new PNotify({
                            title: '{{ 'label.loading_file'|trans }}',
                            text: '0 %',
                            animation: 'none',
                            styling: "bootstrap3",
                            type: 'info'
                        });
                    }
                    {% endblock %}
                },
                always: function () {
                    {% block ajax_upload_always %}
                    $("#new_upload").modal('hide')
                    {% endblock %}
                    upload.reload();
                },
                progress: function (e, data) {
                    {% block ajax_upload_progress %}
                    var progress = parseInt(data.loaded / data.total * 100, 10);
                    if (noty) {
                        noty.update(progress + ' %');
                    }
                    {% endblock %}
                }
            });
        }
    </script>
{% endblock %}
